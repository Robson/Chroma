<!DOCTYPE html>
<html lang="en">
<head>
    <title>Chroma</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="styles.css" />
    <script type="text/javascript" src="rng.js"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <div id="info">
        <div id="about">
            <a href="https://github.com/Robson/Chroma">Code</a> by <a href="https://robson.plus">Robson</a>
        </div>

        <div id="score">

        </div>
        <div id="set">
            <a href="https://en.wikipedia.org/wiki/X11_color_names">X11 Colour Set</a>
        </div>
    </div>
    <div id="question"></div>
    <div id="answers"></div>
    <div id="result"><div id="extra"></div></div>
    <div id="share">
    	<div id="copyResultsAsText" onclick="copyResultsAsText()">Copy Results as Text</div>
    	<br/>
    	<div id="copyResultsAsImage" onclick="copyResultsAsImage()">Copy Results as Image</div>
    </div>
    <div id="next"><div id="nextLevel" onclick="showNewLevel()">Next Question</div></div>
    <div id="finish"><div id="showResults" onclick="showResults()">Show Results</div></div>

    <script type="text/javascript">

		var d = new Date();
		var str = d.getUTCFullYear() + '-' + (d.getUTCMonth()+1) + '-' + d.getUTCDay();
		//str = '2024-10-14';
		var seed = cyrb128(str);
		var rand = splitmix32(seed[0]);

        // obvious/boring colours are commented out
        var colours = [
            ['Alice Blue', 'F0F8FF', 208],
            ['Antique White', 'FAEBD7', 34],
            ['Aqua', '00FFFF', 180],
            ['Aquamarine', '7FFFD4', 160],
            ['Azure', 'F0FFFF', 180],
            ['Beige', 'F5F5DC', 60],
            ['Bisque', 'FFE4C4', 33],
            //['Black', '000000', 0],
            ['Blanched Almond', 'FFEBCD', 36],
            //['Blue', '0000FF', 240],
            ['Blue Violet', '8A2BE2', 271],
            //['Brown', 'A52A2A', 0],
            ['Burlywood', 'DEB887', 34],
            ['Cadet Blue', '5F9EA0', 182],
            ['Chartreuse', '7FFF00', 90],
            ['Chocolate', 'D2691E', 25],
            ['Coral', 'FF7F50', 16],
            ['Cornflower Blue', '6495ED', 219],
            ['Cornsilk', 'FFF8DC', 48],
            ['Crimson', 'DC143C', 348],
            ['Cyan', '00FFFF', 180],
            //['Dark Blue', '00008B', 240],
            ['Dark Cyan', '008B8B', 180],
            ['Dark Goldenrod', 'B8860B', 43],
            //['Dark Gray', 'A9A9A9', 0],
            //['Dark Green', '006400', 120],
            ['Dark Khaki', 'BDB76B', 56],
            ['Dark Magenta', '8B008B', 300],
            ['Dark Olive Green', '556B2F', 82],
            //['Dark Orange', 'FF8C00', 33],
            ['Dark Orchid', '9932CC', 280],
            //['Dark Red', '8B0000', 0],
            ['Dark Salmon', 'E9967A', 15],
            ['Dark Sea Green', '8FBC8F', 120],
            ['Dark Slate Blue', '483D8B', 248],
            ['Dark Slate Gray', '2F4F4F', 180],
            ['Dark Turquoise', '00CED1', 181],
            ['Dark Violet', '9400D3', 282],
            //['Deep Pink', 'FF1493', 328],
            ['Deep Sky Blue', '00BFFF', 195],
            ['Dim Gray', '696969', 0],
            ['Dodger Blue', '1E90FF', 210],
            ['Firebrick', 'B22222', 0],
            ['Floral White', 'FFFAF0', 40],
            ['Forest Green', '228B22', 120],
            ['Fuchsia', 'FF00FF', 300],
            //['Gainsboro', 'DCDCDC', 0],
            ['Ghost White', 'F8F8FF', 240],
            //['Gold', 'FFD700', 51],
            ['Goldenrod', 'DAA520', 43],
            //['Gray', 'BEBEBE', 0],
            //['Web Gray', '808080', 0],
            //['Green', '00FF00', 120],
            //['Web Green', '008000', 120],
            ['Green Yellow', 'ADFF2F', 84],
            ['Honeydew', 'F0FFF0', 120],
            ['Hot Pink', 'FF69B4', 330],
            ['Indian Red', 'CD5C5C', 0],
            ['Indigo', '4B0082', 275],
            ['Ivory', 'FFFFF0', 60],
            ['Khaki', 'F0E68C', 54],
            ['Lavender', 'E6E6FA', 240],
            ['Lavender Blush', 'FFF0F5', 340],
            ['Lawn Green', '7CFC00', 90],
            ['Lemon Chiffon', 'FFFACD', 54],
            //['Light Blue', 'ADD8E6', 195],
            ['Light Coral', 'F08080', 0],
            ['Light Cyan', 'E0FFFF', 180],
            ['Light Goldenrod', 'FAFAD2', 60],
            //['Light Gray', 'D3D3D3', 0],
            //['Light Green', '90EE90', 120],
            //['Light Pink', 'FFB6C1', 351],
            ['Light Salmon', 'FFA07A', 17],
            ['Light Sea Green', '20B2AA', 177],
            ['Light Sky Blue', '87CEFA', 203],
            ['Light Slate Gray', '778899', 210],
            ['Light Steel Blue', 'B0C4DE', 214],
            //['Light Yellow', 'FFFFE0', 60],
            ['Lime', '00FF00', 120],
            ['Lime Green', '32CD32', 120],
            ['Linen', 'FAF0E6', 30],
            ['Magenta', 'FF00FF', 300],
            ['Maroon', 'B03060', 338],
            //['Web Maroon', '800000', 0],
            ['Medium Aquamarine', '66CDAA', 160],
            //['Medium Blue', '0000CD', 240],
            ['Medium Orchid', 'BA55D3', 288],
            //['Medium Purple', '9370DB', 260],
            ['Medium Sea Green', '3CB371', 147],
            ['Medium Slate Blue', '7B68EE', 249],
            ['Medium Spring Green', '00FA9A', 157],
            ['Medium Turquoise', '48D1CC', 178],
            ['Medium Violet Red', 'C71585', 322],
            ['Midnight Blue', '191970', 240],
            ['Mint Cream', 'F5FFFA', 150],
            ['Misty Rose', 'FFE4E1', 6],
            ['Moccasin', 'FFE4B5', 38],
            ['Navajo White', 'FFDEAD', 36],
            ['Navy Blue', '000080', 240],
            ['Old Lace', 'FDF5E6', 39],
            ['Olive', '808000', 60],
            ['Olive Drab', '6B8E23', 80],
            //['Orange', 'FFA500', 39],
            ['Orange Red', 'FF4500', 16],
            ['Orchid', 'DA70D6', 302],
            ['Pale Goldenrod', 'EEE8AA', 55],
            ['Pale Green', '98FB98', 120],
            ['Pale Turquoise', 'AFEEEE', 180],
            ['Pale Violet Red', 'DB7093', 340],
            ['Papaya Whip', 'FFEFD5', 37],
            ['Peach Puff', 'FFDAB9', 28],
            //['Peru', 'CD853F', 30],
            //['Pink', 'FFC0CB', 350],
            ['Plum', 'DDA0DD', 300],
            ['Powder Blue', 'B0E0E6', 187],
            //['Purple', 'A020F0', 277],
            //['Web Purple', '800080', 300],
            ['Rebecca Purple', '663399', 270],
            //['Red', 'FF0000', 0],
            ['Rosy Brown', 'BC8F8F', 0],
            ['Royal Blue', '4169E1', 225],
            ['Saddle brown', '8B4513', 25],
            ['Salmon', 'FA8072', 6],
            ['Sandy Brown', 'F4A460', 28],
            ['Sea Green', '2E8B57', 146],
            ['Seashell', 'FFF5EE', 25],
            ['Sienna', 'A0522D', 19],
            ['Silver', 'C0C0C0', 0],
            ['Sky Blue', '87CEEB', 197],
            ['Slate Blue', '6A5ACD', 248],
            ['Slate Gray', '708090', 210],
            ['Snow', 'FFFAFA', 0],
            ['Spring Green', '00FF7F', 150],
            ['Steel Blue', '4682B4', 207],
            ['Tan', 'D2B48C', 34],
            ['Teal', '008080', 180],
            ['Thistle', 'D8BFD8', 300],
            ['Tomato', 'FF6347', 9],
            ['Turquoise', '40E0D0', 174],
            ['Violet', 'EE82EE', 300],
            ['Wheat', 'F5DEB3', 39],
            //['White', 'FFFFFF', 0],
            ['White Smoke', 'F5F5F5', 0],
            //['Yellow', 'FFFF00', 60],
            ['Yellow Green', '9ACD32', 80],
        ];

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i >= 0; i--) {
                const j = Math.floor(rand() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function hexToRgb(hex) {
            return {
                r: parseInt(hex.slice(0, 2), 16),
                g: parseInt(hex.slice(2, 4), 16),
                b: parseInt(hex.slice(4, 6), 16)
            };
        }

        const levels = 5;
        const MinimumHueDifference = 20;
        const MinimumRgbDifference = 50;

        var correctIndex;
        var answers = [];
        var tracker = [];

        function copyResultsAsText() {

        	var output = '#chroma ';
        	var d = new Date();
			output += d.getUTCFullYear() + '-' + (d.getUTCMonth()+1) + '-' + d.getUTCDay();
        	output += '\r\n';

        	for (var question of tracker) {
        		if (question.correct) {
        			output += '\r\n✅ '
        		} else {
        			output += '\r\n❌ '
        		}
        		output += question.items[question.correctIndex][0] + ' ';
        	}

        	navigator.clipboard.writeText(output);
			alert("Result copied to the clipboard!");
        }

		function sleep(miliseconds) {
		   var currentTime = new Date().getTime();
		   while (currentTime + miliseconds >= new Date().getTime()) {}
		}

        function copyResultsAsImage() {
        	var extra = d3.select('#result #extra');
        	extra.style('display', 'block');
        	sleep(100);
			html2canvas(document.getElementById('result')).then(canvas => {
				// Convert the canvas to Blob
				canvas.toBlob(function(blob) {
					// Use the Clipboard API to copy the Blob
					navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
					.then(() => {
						alert("Result copied to the clipboard!");
					})
					.catch(err => {
						alert("Something went wrong whilst copying the image to the clipboard :(");
					});
				});
			});
			sleep(100);
			extra.style('display', 'none');
        }

        function showResults() {
            d3.select('#question').html("Finished!");
            d3.select('#answers').style('display', 'none');
            d3.select('#finish').style('display', 'none');
            d3.select('#score').style('display', 'none');
            d3.select('#share').style('display', 'block');
            d3.select('#result').style('display', 'inline-block');
            d3.selectAll('#share *').style('display', 'inline-block');
            var amountCorrect = tracker.filter(a => a.correct).length;
            var exclamation = '';
            if (amountCorrect == levels) {
                exclamation = '. Perfect!';
            } else if (amountCorrect == levels - 1) {
                exclamation = '. Excellent!';
            }
            d3.select('#question').style('padding', '20px 10px 25px 10px')
            d3.select('#question').html(amountCorrect + ' correct out of ' + levels + exclamation)
            var resultBox = d3.select('#result');
            var extraBox = d3.select('#extra');
            //extraBox.style('display', 'none');
			var d = new Date();
            extraBox
            	.append('div')
            	.html('Chroma<br/>' +
            	      d.getUTCFullYear() + '-' + (d.getUTCMonth()+1) + '-' + d.getUTCDay() + '<br/>' +
            	      amountCorrect + ' correct out of ' + levels);

            for (var question of tracker) {
                var line = resultBox.append('div');
                line.append('p').html(question.items[question.correctIndex][0]);
                var miniAnswers = line.append('div');
                miniAnswers.classed('answerMini');
                for (var index in question.items) {
                    var circle = question.items[index];
                    var rgb = hexToRgb(circle[1]);
                    var hsp = Math.sqrt(
                        0.299 * (rgb.r * rgb.r) +
                        0.587 * (rgb.g * rgb.g) +
                        0.114 * (rgb.b * rgb.b)
                    );
                    var inside = '';
                    if (+index == +question.correctIndex) {
                        inside = '&#9745;';
                    } else if (+index == +question.clickedIndex) {
                        inside = '&#9746;';
                    }
                    miniAnswers
                        .append('div')
                        .attr('class', 'answersMini')
                        .attr('title', circle[0])
                        .style('background-color', '#' + circle[1])
                        .style('color', hsp > 127.5 ? 'black' : 'white')
                        .html(inside)
                }
            }
        }

        function showScore() {
            var score = d3.select('#score');
            var html = '';
            for (var a = 0; a < levels; a++) {
                if (tracker[a]) {
                    html += '<span>' + (tracker[a].correct ? '&#9745;' : '&#9746;') + '</span>';
                } else {
                    html += '<span>&#9744;</span>';
                }
            }
            score.html(html);
            if (tracker.length == levels) {
                d3.select('#finish').style('display', 'inline-block');
            } else {
                d3.select('#next').style('display', 'inline-block');
            }
        }

        function clickAnswer(index) {
            var log = {
                clickedIndex: index,
                correctIndex: correctIndex,
                correct: index == correctIndex,
                items: answers.slice(0)
            }
            for (var a = 0; a < answers.length; a++) {
                var circle = d3.select('.answer' + a);
                circle.classed('enabled', false);
                circle.on('mousedown', null);
                if (a == correctIndex) {
                    circle.html('&#9745;');
                } else if (a == index) {
                    circle.html('&#9746;');
                }
            }
            tracker.push(log);
            showScore();
        }

        showScore();

        function showNewLevel() {

            d3.select('#next').style('display', 'none');

            var shuffled = colours.slice(0);
            shuffleArray(shuffled);

            var amount = 6;
            answers = [];
            answers = [shuffled[0]];

            for (var a = 1; a < shuffled.length; a++) {
                var isValid = true;
                for (var b = 0; b < answers.length; b++) {
                    if (Math.abs(shuffled[a][2] - answers[b][2]) < MinimumHueDifference) {
                        isValid = false;
                    }
                    var rgbExisting = hexToRgb(answers[b][1]);
                    var rgbCandidate = hexToRgb(shuffled[a][1]);
                    if (Math.abs(rgbExisting.r - rgbCandidate.r) +
                        Math.abs(rgbExisting.g - rgbCandidate.g) +
                        Math.abs(rgbExisting.b - rgbCandidate.b) < MinimumRgbDifference) {
                        isValid = false;
                    }
                }
                if (isValid) {
                    answers.push(shuffled[a]);
                }
                if (answers.length == amount) {
                    break;
                }
            }

            correctIndex = ~~(rand() * amount);

            d3.select('#question').html('Which circle is <span class="highlight">' + answers[correctIndex][0] + '?</span>');

            d3.selectAll('#answers div').remove();
            for (var index in answers) {
                var colour = answers[index];
                var rgb = hexToRgb(colour[1]);
                var hsp = Math.sqrt(
                    0.299 * (rgb.r * rgb.r) +
                    0.587 * (rgb.g * rgb.g) +
                    0.114 * (rgb.b * rgb.b)
                );

                d3.select('#answers')
                    .append('div')
                    .attr('class', 'answer enabled answer' + index)
                    .attr('data-index', index)
                    .style('background-color', '#' + colour[1])
                    .style('color', hsp > 127.5 ? 'black' : 'white')
                    .html('&nbsp;')
                    .on('mousedown', function () { clickAnswer(d3.select(this).attr('data-index')) });

				if (index == 2) {
					d3.select('#answers')
						.append('div')
						.attr('class', 'mobileBreaker');
				}
            }

        }

        showNewLevel();

    </script>

</body>
</html>