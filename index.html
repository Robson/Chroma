<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2E561F2422"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-2E561F2422');
    </script>
    <!--
    ************************************************
    The script above is for google analytics.
    You'll want to remove that if you use this page.
    ************************************************
    -->
    <title>Chroma</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="styles.css" />
    <script type="text/javascript" src="rng.js"></script>
    <script type="text/javascript" src="colours.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

    <div id="info">
        <div id="about">
            <a href="https://github.com/Robson/Chroma">Code</a> by <a href="https://robson.plus">Robson</a>
        </div>
        <div id="set">
            Colours: <a id="colourSet"></a>
        </div>
    </div>
    <div id="progress">&#9671;&#9671;&#9671;&#9671;&#9671;</div>
    <div id="question"></div>
    <div id="answers"></div>
    <div id="result"><div id="extra"></div></div>
    <div id="share">
    	<div id="copyResultsMobile" onclick="copyResultsAsText()">Copy Results</div>
    	<div id="copyResultsAsText" onclick="copyResultsAsText()">Copy Results as Text</div>
    	<br/>
    	<div id="copyResultsAsImage" onclick="copyResultsAsImage()">Copy Results as Image</div>
    </div>
    <div id="next"><div id="nextLevel" onclick="showNewLevel()">Next Question</div></div>
    <div id="finish"><div id="showResults" onclick="showResults()">Show Results</div></div>

    <script type="text/javascript">

        var correctIndex;
        var answers = [];
        var tracker = [];
        var fixedAnswers = null;

    	const levels = 5;
        var minimumDeltaDifference = 30;

		function getDaysBetweenDates(startDate, endDate) {
			const oneDay = 1000 * 60 * 60 * 24;
			const start = Date.UTC(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
			const end = Date.UTC(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
			return Math.round((end - start) / oneDay);
		}

		const startDate = new Date(Date.UTC(2024, 9, 13));
		const endDate = new Date(); // Current date
		var daysBetween = getDaysBetweenDates(startDate, endDate);

		const now = new Date();
		const month = now.getUTCMonth() + 1;
		const date = now.getUTCDate();
		var hash = date + '-' + month;

		if (window.location.hash.substring(1) == 'random') {
			daysBetween = Math.floor(Math.random() * 10000000);
		}
		if (window.location.hash.substring(1).length > 0) {
			daysBetween = Math.floor(Math.random() * 10000000);
			hash = window.location.hash.substring(1);
		}

		var seed = cyrb128('a' + daysBetween);
        var rand = splitmix32(seed[0]);

        var set = coloursDuluxPopular;
		switch (Math.floor(rand() * 2)) {
			case 0:
				var set = coloursDuluxPopular;
				break;
			case 1:
				var set = coloursDuluxHeritage;
				break;
		}

		switch (hash) {
			case '17-3': // saint patrick's day (all green)
				set = coloursDuluxPopular;
				fixedAnswers = [
					'Pixie Green',
					'Enchanted Eden',
					'Highland Green',
					'Buckingham',
					'Emerald Glade',
				];
				shuffleArray(fixedAnswers);
				break;
			case '31-10': // halloween (all orange)
				set = coloursDuluxPopular;
				fixedAnswers = [
					'Tangerine Twist',
					'Rocket Fire',
					'Orange Fizz',
					'Collective Coral',
					'Moroccan Flame',
				];
				shuffleArray(fixedAnswers);
				break;
			case '25-12': // christmas (all red and green)
				set = coloursDuluxPopular;
				fixedAnswers = [
					'Salsa Red',
					'Pixie Green',
					'Pepper Red',
					'Volcanic Red',
					'Highland Green'
				];
				shuffleArray(fixedAnswers);
				break;
		}

		var colours = set.items;
		minimumDeltaDifference = set.deltaMinimum;
		d3.select('#colourSet')
			.attr('href', set.link)
			.text(set.name);

		// convert 0-255 rgb to hex rgb, if necessary
		for (var a = 0; a < colours.length; a++) {
			if (colours[a][1].includes(',')) {
				colours[a][1] = colours[a][1].replace(/ /g, '');
				var parts = colours[a][1].split(',');
				colours[a][1] = parts.map(a => ('0' + (+a).toString(16)).slice(-2)).join('');
			}
		}

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i >= 0; i--) {
                const j = Math.floor(rand() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function hexToRgb(hex) {
            return {
                r: parseInt(hex.slice(0, 2), 16),
                g: parseInt(hex.slice(2, 4), 16),
                b: parseInt(hex.slice(4, 6), 16)
            };
        }

        function copyResultsAsText() {
        	var output = '#Chroma\r\n';
        	var d = new Date();
			output += 'Challenge ' + (daysBetween + 1);
        	output += '\r\n';
        	for (var question of tracker) {
        		if (question.correct) {
        			output += '\r\n✅ '
        		} else {
        			output += '\r\n❌ '
        		}
        		output += question.items[question.correctIndex][0] + ' ';
        	}
        	navigator.clipboard.writeText(output);
			alert("Result copied to the clipboard!");
        }

        function copyResultsAsImage() {
			html2canvas(document.getElementById('result')).then(canvas => {
				canvas.toBlob(function(blob) {
					navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
					.then(() => {
						alert("Result copied to the clipboard!");
					})
					.catch(err => {
						alert("Something went wrong whilst copying the image to the clipboard :(");
					});
				});
			});
        }

        function showResults() {
            d3.select('#answers').style('display', 'none');
            d3.select('#finish').style('display', 'none');
            d3.select('#progress').style('display', 'none');
            d3.select('#question').style('display', 'none');
            d3.select('#share').style('display', 'block');
            d3.select('#result').style('display', 'inline-block');
            var amountCorrect = tracker.filter(a => a.correct).length;
            var exclamation = '';
            if (amountCorrect == levels) {
                exclamation = '. Perfect!';
            } else if (amountCorrect == levels - 1) {
                exclamation = '. Excellent!';
            }
            var resultBox = d3.select('#result');
            var extraBox = d3.select('#extra');
            extraBox.style('display', 'block');
			var d = new Date();
            extraBox
            	.append('div')
            	.html('Chroma<br/>' +
            	      'Challenge ' + (daysBetween + 1) + '<br/>' +
            	      amountCorrect + ' correct out of ' + levels);

            for (var question of tracker) {
                var line = resultBox.append('div');
                line.append('p').html(question.items[question.correctIndex][0]);
                var miniAnswers = line.append('div');
                miniAnswers.classed('answerMini');
                for (var index in question.items) {
                    var circle = question.items[index];
                    var rgb = hexToRgb(circle[1]);
                    var hsp = Math.sqrt(
                        0.299 * (rgb.r * rgb.r) +
                        0.587 * (rgb.g * rgb.g) +
                        0.114 * (rgb.b * rgb.b)
                    );
                    var inside = '';
                    if (+index == +question.correctIndex) {
                        inside = '&#9745;';
                    } else if (+index == +question.clickedIndex) {
                        inside = '&#9746;';
                    }
                    miniAnswers
                        .append('div')
                        .attr('class', 'answersMini')
                        .attr('title', circle[0])
                        .style('background-color', '#' + circle[1])
                        .style('color', hsp > 127.5 ? 'black' : 'white')
                        .html(inside)
                }
            }
        }

        function clickAnswer(index) {
            var log = {
                clickedIndex: index,
                correctIndex: correctIndex,
                correct: index == correctIndex,
                items: answers.slice(0)
            }
            for (var a = 0; a < answers.length; a++) {
                var circle = d3.select('.answer' + a);
                circle.classed('enabled', false);
                circle.on('mousedown', null);
                if (a == correctIndex) {
                    circle.html('&#9745;');
                } else if (a == index) {
                    circle.html('&#9746;');
                }
            }
            tracker.push(log);
            if (tracker.length == levels) {
                d3.select('#finish').style('display', 'inline-block');
            } else {
                d3.select('#next').style('display', 'inline-block');
            }
        }

        function showNewLevel() {

            d3.select('#next').style('display', 'none');

            var shuffled = colours.slice(0);
            shuffleArray(shuffled);

			// reroll if we have already had this colour.
			// this ensures that at least one colour is new
			// and therefore there is always a valid answer
            var isValid = true;
            do {
            	isValid = true;
            	for (var old of tracker) {
            		if (old.items[old.correctIndex][0] == shuffled[0][0]) {
            			isValid = false;
            		}
            	}
            	if (!isValid) {
            		shuffleArray(shuffled);
            	}
            } while (!isValid);

            var amount = 6;
            // start the answer array with the item that we ensured is a valid answer.
            // the array will get shuffled later
            answers = [shuffled[0]];

            // overwrite if it is a special day
            if (fixedAnswers) {
            	var chosen = shuffled.filter(a => a[0] == fixedAnswers[tracker.length])[0];
            	answers = [chosen];
            }

            for (var a = 1; a < shuffled.length; a++) {
                var isValid = true;
                for (var b = 0; b < answers.length; b++) {
                    var rgbExisting = hexToRgb(answers[b][1]);
                    var rgbCandidate = hexToRgb(shuffled[a][1]);
                    var deltaDiff = deltaE([rgbExisting.r, rgbExisting.g, rgbExisting.b], [rgbCandidate.r, rgbCandidate.g, rgbCandidate.b]);
                    if (deltaDiff <= minimumDeltaDifference) {
                        isValid = false;
                    }
                    // check if from the same set
                    if (shuffled[a][3] > 0 && shuffled[a][3] == answers[b][3]) {
                        isValid = false;
                    }
                }
                if (isValid) {
                    answers.push(shuffled[a]);
                }
                if (answers.length == amount) {
                    break;
                }
            }

            if (answers.length < amount) {
                showNewLevel();
                return;
            }

            shuffleArray(answers);

            var isValid = true;
            do {
				correctIndex = ~~(rand() * answers.length);
            	isValid = true;
            	for (var old of tracker) {
            		if (old.items[old.correctIndex][0] == answers[correctIndex][0]) {
            			isValid = false;
            		}
            	}
            } while (!isValid);

            if (fixedAnswers) {
            	//console.log(answers);
            	//console.log(fixedAnswers[tracker.length]);
            	correctIndex = answers.findIndex(a => a[0] == fixedAnswers[tracker.length]);
            }

            d3.select('#question').html('Which circle is <span class="highlight">' + answers[correctIndex][0] + '?</span>');

            d3.selectAll('#answers div').remove();
            for (var index in answers) {
                var colour = answers[index];
                var rgb = hexToRgb(colour[1]);
                var hsp = Math.sqrt(
                    0.299 * (rgb.r * rgb.r) +
                    0.587 * (rgb.g * rgb.g) +
                    0.114 * (rgb.b * rgb.b)
                );

                d3.select('#answers')
                    .append('div')
                    .attr('class', 'answer enabled answer' + index)
                    .attr('data-index', index)
                    .style('background-color', '#' + colour[1])
                    .style('color', hsp > 127.5 ? 'black' : 'white')
                    .html('&nbsp;')
                    .on('mousedown', function () { clickAnswer(d3.select(this).attr('data-index')) });

				if (index % 3 == 2) {
					d3.select('#answers')
						.append('div')
						.attr('class', 'mobileBreaker');
				}
            }

            var progress = d3.select('#progress');
            var html = '';
            for (var a = 0; a < levels; a++) {
            	if (tracker.length == a) {
            		html += '&#9672;';
            	} else if (tracker.length > a) {
            		html += '&#9670;';
            	} else {
            		html += '&#9671;';
            	}
            }
            progress.html(html);

        }

        showNewLevel();

    </script>

</body>
</html>